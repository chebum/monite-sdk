<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <link href="/favicon.ico" rel="icon" type="image/svg+xml"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
    }
  </style>
  <title>Monite App Widget Label</title>
</head>
<body>
<monite-iframe-app
  name-prop="iframeApp"
  api-url="lazy"
  basename="/monite-app"
  component="counterparts"
  entity-id="lazy"
>
  <script slot="fetch-token">
    async function fetchIframeToken() {
      return await window.fetchToken();
    }

    //ToDO: Check if token is expired and renew it if needed
    async function renewTokenIfNeeded() {
      const tokenData = await fetchToken();
      if (new Date() > new Date(tokenData.expires_at)) {
        return await fetchToken();
      }
      return tokenData;
    }
  </script>

  <script slot="theme" type="application/json">
    {
      "typography": {
        "fontFamily": "Comic Sans MS, Comic Sans, cursive, monospace"
      }
    }
  </script>

  <script slot="locale" type="application/json">
    {
      "code": "de-DE",
      "messages": {
        "Name, country, city": "City Test",
        "Payables": "My Payables"
      }
    }
  </script>
</monite-iframe-app>

<script type="module">
  (async () => {
    const {getConfig} = await import('@team-monite/sdk-demo');
    const {api_url, entity_id} = await getConfig();

    const moniteAppNode = document.querySelector('monite-iframe-app');
    moniteAppNode.setAttribute('api-url', `${api_url}/v1`);
    moniteAppNode.setAttribute('entity-id', entity_id);
  })().catch((error) => {
    console.error(error);
    throw new Error('Error while fetching credentials');
  });
</script>

<script type="module">
  window.fetchToken = async () => {
    try {
      const {fetchToken, getConfig} = await import('@team-monite/sdk-demo');
      const {api_url, entity_user_id, client_id, client_secret} = await getConfig();

      return await fetchToken(`${api_url}/v1`, {
        entity_user_id,
        client_id,
        client_secret,
      });
    } catch (error) {
      console.error(error);
      throw new Error('Error while fetching token');
    }
  };
</script>

<script>
  window.addEventListener('message', async (event) => {
    const allowedOrigin = "https://trusted-iframe-source.com"; //ToDo check

    if (event.origin !== allowedOrigin) {
      console.error('Received message from untrusted origin:', event.origin);
      return;
    }

    if (event.data.action === 'requestToken') {
      const token = await window.fetchToken();
      event.source.postMessage({ action: 'deliverToken', token: token }, allowedOrigin);
    }
  });

</script>

<script src="/src/index.ts" type="module"></script>
</body>
</html>
